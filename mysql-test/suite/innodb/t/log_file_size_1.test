--echo # Test resizing the InnoDB redo log.

--source include/have_debug.inc

--source ../include/redo_log_error_patterns.inc

SET GLOBAL innodb_checkpoint_disabled = 1;
SET GLOBAL innodb_fast_shutdown = 2;

CREATE TABLE t1(id INT PRIMARY KEY,bfield BLOB) ENGINE=InnoDB;
INSERT INTO t1 VALUES (1,repeat('a',2000)),(2,repeat('b',2000)),
(3,repeat('c',2000));
START TRANSACTION;
INSERT INTO t1 VALUES (11,repeat('a',2000)),(12,repeat('b',2000)),
(13,repeat('c',2000));
SAVEPOINT A;
INSERT INTO t1 VALUES (21,repeat('a',2000)),(22,repeat('b',2000)),
(23,repeat('c',2000));
SAVEPOINT B;
SELECT id,LEFT(bfield,20) FROM t1;
ROLLBACK TO A;
COMMIT;
SELECT id,LEFT(bfield,20) FROM t1;

--echo
--echo # Restart with different redo log size (20M)
--let $MYSQLD_LOG_1= $MYSQLTEST_VARDIR/log/log_file_size-1.log
--let $restart_parameters = "restart: --innodb-redo-log-capacity=20M --log-error=$MYSQLD_LOG_1"
--replace_result $MYSQLD_LOG_1 MYSQLD_LOG
--source include/restart_mysqld.inc

SET GLOBAL innodb_checkpoint_disabled = 1;
SET GLOBAL innodb_fast_shutdown = 2;

let SEARCH_FILE= $MYSQLD_LOG_1;
let SEARCH_PATTERN= $PATTERN_STARTING_CRASH_RECOVERY;
--source include/search_pattern.inc

SELECT id,LEFT(bfield,20) FROM t1;

--ERROR ER_DUP_ENTRY
INSERT INTO t1 VALUES (1,repeat('a',2000)),(2,repeat('b',2000)),
(3,repeat('c',2000));
INSERT INTO t1 VALUES (21,repeat('a',2000)),(22,repeat('b',2000)),
(23,repeat('c',2000));
SELECT id,LEFT(bfield,20) FROM t1;

--echo
--echo # Restart with different redo log size (8M)
--let $MYSQLD_LOG_2= $MYSQLTEST_VARDIR/log/log_file_size-2.log
--let $restart_parameters = "restart: --innodb-redo-log-capacity=8M --log-error=$MYSQLD_LOG_2"
--replace_result $MYSQLD_LOG_2 MYSQLD_LOG
--source include/restart_mysqld.inc

SET GLOBAL innodb_checkpoint_disabled = 1;
SET GLOBAL innodb_fast_shutdown = 2;

let SEARCH_FILE= $MYSQLD_LOG_2;
let SEARCH_PATTERN= $PATTERN_STARTING_CRASH_RECOVERY;
--source include/search_pattern.inc

--ERROR ER_DUP_ENTRY
INSERT INTO t1 VALUES (21,repeat('a',2000));
INSERT INTO t1 VALUES (24,repeat('a',2000)),(25,repeat('b',2000));
SELECT id,LEFT(bfield,20) FROM t1;

<<<<<<< HEAD
# end of testcase 2. Do not drop table/database as it is used in foloowing case

# testcase misc
let MYSQLD_DATADIR= `select @@datadir`;
let SEARCH_FILE= $MYSQLTEST_VARDIR/log/my_restart.err;
let $args=--loose-console --core-file > $SEARCH_FILE 2>&1;

# Stop the server
SET GLOBAL innodb_fast_shutdown=0;
--source include/shutdown_mysqld.inc

--echo "test misc 1"
# InnoDB aborts
--error 1
--exec $MYSQLD_CMD $args --innodb-log-group-home-dir=foo\;bar
let SEARCH_PATTERN= syntax error in innodb_log_group_home_dir;
--source include/search_pattern.inc
--remove_file $SEARCH_FILE

--echo "test misc 3"
--error 1,42
--exec $MYSQLD_CMD $args --innodb-read-only
let SEARCH_PATTERN=  Cannot resize log files in read-only mode;
--source include/search_pattern.inc
--remove_file $SEARCH_FILE

--echo "test misc 4"
# We should have perfectly synced files here.
# Rename the log files, and trigger an error in recovery.
#--move_file $MYSQLD_DATADIR/ib_logfile101 $MYSQLD_DATADIR/ib_logfile0
--move_file $MYSQLD_DATADIR/ib_logfile1 $MYSQLD_DATADIR/ib_logfile1_hidden
--error 1,42
--exec $MYSQLD_CMD $args
let SEARCH_PATTERN=  Only one log file found;
--source include/search_pattern.inc
--remove_file $SEARCH_FILE
#--move_file $MYSQLD_DATADIR/ib_logfile0 $MYSQLD_DATADIR/ib_logfile101
--move_file $MYSQLD_DATADIR/ib_logfile1_hidden $MYSQLD_DATADIR/ib_logfile1

--echo "test misc 5"
# make copy of ib_logfile0 before editing
--move_file $MYSQLD_DATADIR/ib_logfile0 $MYSQLD_DATADIR/ib_logfile0_hidden
perl;
die unless open(FILE, ">$ENV{MYSQLD_DATADIR}/ib_logfile0");
print FILE "garbage";
close(FILE);
EOF
--error 1,42
--exec $MYSQLD_CMD $args
let SEARCH_PATTERN=  .*ib_logfile0 size 7 is not a multiple of innodb_page_size;
--source include/search_pattern.inc
--remove_file $SEARCH_FILE
--remove_file $MYSQLD_DATADIR/ib_logfile0
--move_file $MYSQLD_DATADIR/ib_logfile0_hidden $MYSQLD_DATADIR/ib_logfile0


--echo "test misc 6"
--move_file $MYSQLD_DATADIR/ib_logfile1 $MYSQLD_DATADIR/ib_logfile1_hidden
perl;
die unless open(FILE, ">$ENV{MYSQLD_DATADIR}/ib_logfile1");
print FILE "junkfill" x 131072;
close(FILE);
EOF

--error 1,42
--exec $MYSQLD_CMD $args
let SEARCH_PATTERN=  .*ib_logfile1 is of different size;
--source include/search_pattern.inc
--remove_file $SEARCH_FILE
--remove_file $MYSQLD_DATADIR/ib_logfile1
--move_file $MYSQLD_DATADIR/ib_logfile0 $MYSQLD_DATADIR/ib_logfile0_hidden

# restart server
let $restart_parameters = restart;
--source include/start_mysqld.inc
USE db_wl6494;
SELECT id,LEFT(bfield,20) FROM t1;
--ERROR ER_DUP_ENTRY
INSERT INTO t1 VALUES (1,repeat('a',2000)),(2,repeat('b',2000)),
(3,repeat('c',2000));
||||||| merged common ancestors
# end of testcase 2. Do not drop table/database as it is used in foloowing case

# testcase misc
let MYSQLD_DATADIR= `select @@datadir`;
let SEARCH_FILE= $MYSQLTEST_VARDIR/log/my_restart.err;
let $args=--loose-console --core-file > $SEARCH_FILE 2>&1;

# Stop the server
SET GLOBAL innodb_fast_shutdown=0;
--source include/shutdown_mysqld.inc

--echo "test misc 1"
# InnoDB aborts
--error 1
--exec $MYSQLD_CMD $args --innodb-log-group-home-dir=foo\;bar
let SEARCH_PATTERN= syntax error in innodb_log_group_home_dir;
--source include/search_pattern.inc
--remove_file $SEARCH_FILE

--echo "test misc 3"
--error 1
--exec $MYSQLD_CMD $args --innodb-read-only
let SEARCH_PATTERN=  Cannot resize log files in read-only mode;
--source include/search_pattern.inc
--remove_file $SEARCH_FILE

--echo "test misc 4"
# We should have perfectly synced files here.
# Rename the log files, and trigger an error in recovery.
#--move_file $MYSQLD_DATADIR/ib_logfile101 $MYSQLD_DATADIR/ib_logfile0
--move_file $MYSQLD_DATADIR/ib_logfile1 $MYSQLD_DATADIR/ib_logfile1_hidden
--error 1
--exec $MYSQLD_CMD $args
let SEARCH_PATTERN=  Only one log file found;
--source include/search_pattern.inc
--remove_file $SEARCH_FILE
#--move_file $MYSQLD_DATADIR/ib_logfile0 $MYSQLD_DATADIR/ib_logfile101
--move_file $MYSQLD_DATADIR/ib_logfile1_hidden $MYSQLD_DATADIR/ib_logfile1

--echo "test misc 5"
# make copy of ib_logfile0 before editing
--move_file $MYSQLD_DATADIR/ib_logfile0 $MYSQLD_DATADIR/ib_logfile0_hidden
perl;
die unless open(FILE, ">$ENV{MYSQLD_DATADIR}/ib_logfile0");
print FILE "garbage";
close(FILE);
EOF
--error 1
--exec $MYSQLD_CMD $args
let SEARCH_PATTERN=  .*ib_logfile0 size 7 is not a multiple of innodb_page_size;
--source include/search_pattern.inc
--remove_file $SEARCH_FILE
--remove_file $MYSQLD_DATADIR/ib_logfile0
--move_file $MYSQLD_DATADIR/ib_logfile0_hidden $MYSQLD_DATADIR/ib_logfile0


--echo "test misc 6"
--move_file $MYSQLD_DATADIR/ib_logfile1 $MYSQLD_DATADIR/ib_logfile1_hidden
perl;
die unless open(FILE, ">$ENV{MYSQLD_DATADIR}/ib_logfile1");
print FILE "junkfill" x 131072;
close(FILE);
EOF

--error 1
--exec $MYSQLD_CMD $args
let SEARCH_PATTERN=  .*ib_logfile1 is of different size;
--source include/search_pattern.inc
--remove_file $SEARCH_FILE
--remove_file $MYSQLD_DATADIR/ib_logfile1
--move_file $MYSQLD_DATADIR/ib_logfile0 $MYSQLD_DATADIR/ib_logfile0_hidden

# restart server
let $restart_parameters = restart;
--source include/start_mysqld.inc
USE db_wl6494;
SELECT id,LEFT(bfield,20) FROM t1;
--ERROR ER_DUP_ENTRY
INSERT INTO t1 VALUES (1,repeat('a',2000)),(2,repeat('b',2000)),
(3,repeat('c',2000));
=======
--echo
--echo # Restart with default parameters
let $restart_parameters=restart:;
--source include/restart_mysqld.inc
>>>>>>> percona/ps/release-8.0.30-22

--echo
--echo # Cleanup
DROP TABLE t1;

# It might be useful to comment out code below, when debugging test failures
--remove_file $MYSQLD_LOG_1
--remove_file $MYSQLD_LOG_2
