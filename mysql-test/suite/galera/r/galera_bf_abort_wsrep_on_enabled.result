CREATE TABLE t1(id INT PRIMARY KEY AUTO_INCREMENT, k INT);
INSERT INTO t1(k) VALUES (1),(2),(3),(101),(102),(103);
SET SESSION wsrep_on = ON;;
BEGIN;
UPDATE t1 SET k=k+1 WHERE id<100;
ALTER TABLE t1 ADD KEY(k);
COMMIT;
ERROR 40001: WSREP detected deadlock/conflict and aborted the transaction. Try restarting the transaction
SET DEBUG_SYNC="open_tables_after_open_and_process_table SIGNAL open_tables_after_open_and_process_table.reached WAIT_FOR open_tables_after_open_and_process_table.continue";
UPDATE t1 SET k=k+1 WHERE id<100;
SET DEBUG_SYNC="NOW WAIT_FOR open_tables_after_open_and_process_table.reached";
ALTER TABLE t1 ADD KEY(k);
Warnings:
Warning	1831	Duplicate index 'k_2' defined on the table 'test.t1'. This is deprecated and will be disallowed in a future release.
BEGIN;
UPDATE t1 SET k=k+1 WHERE id<100;
ALTER TABLE t1 ADD KEY(k);
Warnings:
Warning	1831	Duplicate index 'k_3' defined on the table 'test.t1'. This is deprecated and will be disallowed in a future release.
COMMIT;
ERROR 40001: WSREP detected deadlock/conflict and aborted the transaction. Try restarting the transaction
SET DEBUG_SYNC="open_tables_after_open_and_process_table SIGNAL open_tables_after_open_and_process_table.reached WAIT_FOR open_tables_after_open_and_process_table.continue";
UPDATE t1 SET k=k+1 WHERE id<100;
SET DEBUG_SYNC="NOW WAIT_FOR open_tables_after_open_and_process_table.reached";
ALTER TABLE t1 ADD KEY(k);
Warnings:
Warning	1831	Duplicate index 'k_4' defined on the table 'test.t1'. This is deprecated and will be disallowed in a future release.
SET SESSION wsrep_on = ON;
DROP TABLE t1;
SET DEBUG_SYNC="RESET";
