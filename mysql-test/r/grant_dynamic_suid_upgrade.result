#
# Test for WL#15874: Separate privileges for definer object creation
#   and orphan object protection from SET_USER_ID and
#   deprecate SET_USER_ID
#
# Also test WL#15875: Remove the deprecated SET_USER_ID privilege
#
# Test FR3
# Test: FR8: Should have no result rows
SELECT GRANTEE FROM INFORMATION_SCHEMA.USER_PRIVILEGES
WHERE PRIVILEGE_TYPE = 'SET_USER_ID' ORDER BY 1;
GRANTEE
# Test: FR8: Should include root and mysql.pxc.internal.session
SELECT GRANTEE FROM INFORMATION_SCHEMA.USER_PRIVILEGES
WHERE PRIVILEGE_TYPE = 'SET_ANY_DEFINER' ORDER BY 1;
GRANTEE
'mysql.pxc.internal.session'@'localhost'
'root'@'localhost'
# Test: FR8: Should include root and mysql.pxc.internal.session
SELECT GRANTEE FROM INFORMATION_SCHEMA.USER_PRIVILEGES
WHERE PRIVILEGE_TYPE = 'ALLOW_NONEXISTENT_DEFINER' ORDER BY 1;
GRANTEE
'mysql.pxc.internal.session'@'localhost'
'root'@'localhost'
# set grants as it used to be pre-worklog
CREATE USER wl15874@localhost;
# should fail: no such grant.
GRANT SET_USER_ID ON *.* TO wl15874@localhost;
ERROR 42000: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use
REVOKE SET_ANY_DEFINER,ALLOW_NONEXISTENT_DEFINER ON *.* FROM root@localhost;
<<<<<<< HEAD
REVOKE SET_ANY_DEFINER,ALLOW_NONEXISTENT_DEFINER ON *.* FROM 'mysql.pxc.internal.session'@localhost;
GRANT SET_USER_ID ON *.* TO wl15874@localhost WITH GRANT OPTION;
Warnings:
Warning	6016	The privilege 'SET_USER_ID' is deprecated.
GRANT SET_USER_ID ON *.* TO root@localhost WITH GRANT OPTION;
Warnings:
Warning	6016	The privilege 'SET_USER_ID' is deprecated.
GRANT SET_USER_ID ON *.* TO 'mysql.pxc.internal.session'@localhost;
Warnings:
Warning	6016	The privilege 'SET_USER_ID' is deprecated.
||||||| merged common ancestors
GRANT SET_USER_ID ON *.* TO wl15874@localhost WITH GRANT OPTION;
Warnings:
Warning	6016	The privilege 'SET_USER_ID' is deprecated.
GRANT SET_USER_ID ON *.* TO root@localhost WITH GRANT OPTION;
Warnings:
Warning	6016	The privilege 'SET_USER_ID' is deprecated.
=======
INSERT INTO mysql.global_grants(USER,HOST,PRIV, WITH_GRANT_OPTION)
VALUES ('wl15874', 'localhost', 'SET_USER_ID', 'Y');
INSERT INTO mysql.global_grants(USER,HOST,PRIV, WITH_GRANT_OPTION)
VALUES ('root', 'localhost', 'SET_USER_ID', 'Y');
>>>>>>> ps/release-8.4.0-1
# restart:--upgrade=FORCE
# Restart server with defaults
# restart:
<<<<<<< HEAD
# Test FR4: SET_USER_ID deprecated at startup: must be 3: root, wl15784 and mysql.pxc.internal.session
||||||| merged common ancestors
# Test FR4: SET_USER_ID deprecated at startup: must be 2: root and wl15784
=======
# should fail after a restart and set_user_id present: no such grant.
GRANT SET_USER_ID ON *.* TO wl15874@localhost;
ERROR 42000: You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use
# Test FR4: SET_USER_ID deprecated at startup. Must be 0: deprecation gone
>>>>>>> ps/release-8.4.0-1
select COUNT(*) FROM performance_schema.error_log
WHERE PRIO='Warning' AND DATA REGEXP 'SET_USER_ID.*deprecated';
COUNT(*)
<<<<<<< HEAD
3
# FR3: should return 2 rows: wl15874 and root
||||||| merged common ancestors
2
# FR3: should return 2 rows: wl15874 and root
=======
0
# WL#15875 FR4: should return 0 rows: SET_USER_ID gone
>>>>>>> ps/release-8.4.0-1
SELECT GRANTEE FROM INFORMATION_SCHEMA.USER_PRIVILEGES
WHERE PRIVILEGE_TYPE = 'SET_USER_ID' ORDER BY 1;
GRANTEE
<<<<<<< HEAD
'mysql.pxc.internal.session'@'localhost'
'root'@'localhost'
'wl15874'@'localhost'
# FR3: should return 3 rows: root, wl15874 and mysql.pxc.internal.session
||||||| merged common ancestors
'root'@'localhost'
'wl15874'@'localhost'
# FR3: should return 2 rows: root and wl15874
=======
# FR3: should return 2 rows: root and wl15874
>>>>>>> ps/release-8.4.0-1
SELECT GRANTEE FROM INFORMATION_SCHEMA.USER_PRIVILEGES
WHERE PRIVILEGE_TYPE = 'SET_ANY_DEFINER' ORDER BY 1;
GRANTEE
'mysql.pxc.internal.session'@'localhost'
# FR3: should return 3 rows: root, wl15874 and mysql.pxc.internal.session
SELECT GRANTEE FROM INFORMATION_SCHEMA.USER_PRIVILEGES
WHERE PRIVILEGE_TYPE = 'ALLOW_NONEXISTENT_DEFINER' ORDER BY 1;
GRANTEE
'mysql.pxc.internal.session'@'localhost'
# set grants to test FR3.1
<<<<<<< HEAD
REVOKE SET_USER_ID,ALLOW_NONEXISTENT_DEFINER,SET_ANY_DEFINER ON *.* FROM wl15874@localhost;
REVOKE SET_USER_ID,ALLOW_NONEXISTENT_DEFINER,SET_ANY_DEFINER ON *.* FROM root@localhost;
REVOKE SET_USER_ID,ALLOW_NONEXISTENT_DEFINER,SET_ANY_DEFINER ON *.* FROM 'mysql.pxc.internal.session'@localhost;
||||||| merged common ancestors
REVOKE SET_USER_ID,ALLOW_NONEXISTENT_DEFINER,SET_ANY_DEFINER ON *.* FROM wl15874@localhost;
REVOKE SET_USER_ID,ALLOW_NONEXISTENT_DEFINER,SET_ANY_DEFINER ON *.* FROM root@localhost;
=======
REVOKE ALLOW_NONEXISTENT_DEFINER,SET_ANY_DEFINER ON *.* FROM wl15874@localhost;
REVOKE ALLOW_NONEXISTENT_DEFINER,SET_ANY_DEFINER ON *.* FROM root@localhost;
>>>>>>> ps/release-8.4.0-1
GRANT SUPER ON *.* TO wl15874@localhost WITH GRANT OPTION;
Warnings:
Warning	1287	The SUPER privilege identifier is deprecated
# FR3.1: should return 0 rows
SELECT GRANTEE FROM INFORMATION_SCHEMA.USER_PRIVILEGES
WHERE PRIVILEGE_TYPE = 'SET_USER_ID' ORDER BY 1;
GRANTEE
# FR3.1: should return 0 rows
SELECT GRANTEE FROM INFORMATION_SCHEMA.USER_PRIVILEGES
WHERE PRIVILEGE_TYPE = 'SET_ANY_DEFINER' ORDER BY 1;
GRANTEE
# FR3.1: should return 0 rows
SELECT GRANTEE FROM INFORMATION_SCHEMA.USER_PRIVILEGES
WHERE PRIVILEGE_TYPE = 'ALLOW_NONEXISTENT_DEFINER' ORDER BY 1;
GRANTEE
# FR3.1: should return 5 rows: root, mysql.session, wl15874
#        mysql.pxc.internal.session and mysql.pxc.sst.role
SELECT GRANTEE FROM INFORMATION_SCHEMA.USER_PRIVILEGES
WHERE PRIVILEGE_TYPE = 'SUPER' ORDER BY 1;
GRANTEE
'mysql.pxc.internal.session'@'localhost'
'mysql.pxc.sst.role'@'localhost'
'mysql.session'@'localhost'
'root'@'localhost'
'wl15874'@'localhost'
# Upgrade to test FR3.1
# restart:--upgrade=FORCE
# Restart server with defaults to test FR3.1
# restart:
# FR3.1: should return 0 rows
SELECT GRANTEE FROM INFORMATION_SCHEMA.USER_PRIVILEGES
WHERE PRIVILEGE_TYPE = 'SET_USER_ID' ORDER BY 1;
GRANTEE
# FR3.1: should return 5 rows: root, mysql.session, wl15874
#        mysql.pxc.internal.session and mysql.pxc.sst.role
SELECT GRANTEE FROM INFORMATION_SCHEMA.USER_PRIVILEGES
WHERE PRIVILEGE_TYPE = 'SET_ANY_DEFINER' ORDER BY 1;
GRANTEE
'mysql.pxc.internal.session'@'localhost'
'mysql.pxc.sst.role'@'localhost'
'mysql.session'@'localhost'
'root'@'localhost'
'wl15874'@'localhost'
# FR3.1: should return 5 rows: root, mysql.session, wl15874
#        mysql.pxc.internal.session and mysql.pxc.sst.role
SELECT GRANTEE FROM INFORMATION_SCHEMA.USER_PRIVILEGES
WHERE PRIVILEGE_TYPE = 'ALLOW_NONEXISTENT_DEFINER' ORDER BY 1;
GRANTEE
'mysql.pxc.internal.session'@'localhost'
'mysql.pxc.sst.role'@'localhost'
'mysql.session'@'localhost'
'root'@'localhost'
'wl15874'@'localhost'
# Cleanup
REVOKE ALLOW_NONEXISTENT_DEFINER,SET_ANY_DEFINER ON *.* FROM wl15874@localhost;
REVOKE SUPER ON *.* FROM wl15874@localhost;
Warnings:
Warning	1287	The SUPER privilege identifier is deprecated
REVOKE SET_ANY_DEFINER, ALLOW_NONEXISTENT_DEFINER ON *.* FROM 'mysql.session'@'localhost';
REVOKE SET_ANY_DEFINER, ALLOW_NONEXISTENT_DEFINER ON *.* FROM 'mysql.pxc.sst.role'@'localhost';
DROP USER wl15874@localhost;
# End of 8.2 tests
